<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>BECT - Profil</title><link rel="stylesheet" href="style.css"><style>.level-card{background:#1e1e1e;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #333}.level-card h3{margin:0 0 10px 0;color:orange;cursor:pointer}.btn-group{margin-top:10px;display:flex;gap:10px}.btn-dl{background:#4caf50;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer}.btn-del{background:#f44336;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer}</style></head><body><header><button onclick='location.href="index.html"'>‚¨Ö Accueil</button><h1 style="margin-left:20px">Profil de<span id="profile-name" style="color:#00d0ff"></span></h1></header><div style="padding:20px"><button id="btn-publish-level" style="display:none;margin-bottom:20px;background:#2196f3;color:#fff;padding:10px;border:none;border-radius:5px;cursor:pointer">üì§ Publier un nouveau niveau</button><h2>Niveaux publi√©s :</h2><div id="user-levels">Chargement...</div></div><script type="module">import { API_URL, user } from './script.js';const urlParams = new URLSearchParams(window.location.search);const profileUsername = urlParams.get('username');document.getElementById('profile-name').textContent = profileUsername || "Inconnu";const btnPublish = document.getElementById('btn-publish-level');const container = document.getElementById('user-levels');if (user && user.username === profileUsername) { btnPublish.style.display = "inline-block"; btnPublish.onclick = () => window.location.href = 'publier.html';}async function fetchLevels() { if (!profileUsername) { container.innerHTML = "<p>Utilisateur non sp√©cifi√©.</p>"; return; } try { console.log(`Chargement des niveaux pour : ${profileUsername}`); const res = await fetch(`${API_URL}/levels?creator=${encodeURIComponent(profileUsername)}`); const contentType = res.headers.get("content-type"); if (contentType && contentType.indexOf("application/json") === -1) { throw new Error("Le serveur a renvoy√© du HTML au lieu du JSON (Erreur 404 probable)"); } const data = await res.json(); container.innerHTML = ''; if (!data.success || !data.levels || data.levels.length === 0) { container.innerHTML = "<p>Aucun niveau publi√© par cet utilisateur.</p>"; return; } const myLevels = data.levels.filter(lvl => lvl.creator === profileUsername); if (myLevels.length === 0) { container.innerHTML = "<p>Aucun niveau trouv√© pour cet utilisateur.</p>"; return; } myLevels.forEach(level => { const div = document.createElement('div'); div.className = "level-card"; let deleteBtnHTML = ''; if (user && (user.username === level.creator || user.role === "admin")) { deleteBtnHTML = `<button class="btn-del">Supprimer</button>`; } div.innerHTML = ` <h3>${level.title}</h3><p>${level.description || "Pas de description"}</p><div class="btn-group"><button class="btn-dl">T√©l√©charger</button> ${deleteBtnHTML} </div> `; div.querySelector('h3').onclick = () => window.location.href = `niveau.html?id=${level._id}`; div.querySelector('.btn-dl').onclick = async () => { if (!level.jsonUrl) return alert("Fichier JSON non trouv√©."); try { const response = await fetch(level.jsonUrl); if (!response.ok) throw new Error(`Erreur lors du t√©l√©chargement: ${response.status}`); const blob = await response.blob(); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `${level.title}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch(error) { console.error('Download error:', error); alert("Erreur lors du t√©l√©chargement du fichier."); } }; const btnDel = div.querySelector('.btn-del'); if(btnDel){ btnDel.onclick = async () => { if(!confirm("Voulez-vous vraiment supprimer ce niveau ?")) return; try { const r = await fetch(`${API_URL}/levels/${level._id}`, { method: "DELETE", headers: { "Authorization": `Bearer ${user.token}` } }); const contentType = r.headers.get("content-type"); if (!contentType || !contentType.includes("json")) { throw new Error(`Erreur serveur lors de la suppression (${r.status} ${r.statusText})`); } const resDel = await r.json(); if(resDel.success) { div.remove(); alert("Niveau supprim√© !"); } else { alert("Erreur: " + (resDel.message || "Erreur de suppression.")); } } catch(err) { console.error(err); alert("Erreur lors de la suppression: " + err.message); } }; } container.appendChild(div); }); } catch (e) { console.error(e); container.innerHTML = `<p style="color:red">Erreur : ${e.message}</p>`; }}fetchLevels();</script></body></html>